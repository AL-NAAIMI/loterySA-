{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card border-0 shadow-lg mt-4">
            <div class="card-header bg-white border-0 pt-4 pb-0 text-center">
                <h2 class="fw-bold text-primary">Participer √† la Loterie</h2>
                <p class="text-muted">Prix du ticket : <strong>1 ETH</strong></p>
                <p class="text-muted small">‚âà {{ "%.2f"|format(ticket_price_eur) }} EUR</p>
                <div class="alert alert-info mt-3 mb-0 small">
                    <strong>üí° R√©partition :</strong> Le gagnant re√ßoit 90% de la cagnotte, 10% vont √† l'association.
                </div>
            </div>
            <div class="card-body p-4 p-md-5">
                {% if not contract_address %}
                    <div class="alert alert-danger">
                        Aucun contrat actif n'a √©t√© d√©ploy√©.
                    </div>
                {% else %}
                    <div class="mb-4">
                        <label for="pseudo" class="form-label">Votre Pseudo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="pseudo" 
                            placeholder="Ex: PhotoFan2024" 
                            pattern="[a-zA-Z0-9 _-]{2,30}"
                            title="Lettres, chiffres, espaces, tirets et underscores uniquement (2-30 caract√®res)"
                            minlength="2"
                            maxlength="30" 
                            required>
                        <div class="form-text">üîí Ce pseudo sera affich√© si vous gagnez. Lettres, chiffres, espaces, - et _ autoris√©s (2-30 caract√®res).</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-muted small text-uppercase fw-bold">Adresse du Contrat</label>
                        <input type="text" class="form-control bg-light" value="{{ contract_address }}" readonly>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg py-3 fw-bold" onclick="participer()">
                            üéüÔ∏è Participer avec MetaMask (1 ETH)
                        </button>
                    </div>

                    <!-- <div class="alert alert-warning mt-3 small">
                        ü¶ä <strong>MetaMask requis :</strong> Assurez-vous d'avoir MetaMask install√© et connect√© √† votre r√©seau Ganache local.
                    </div> -->
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Web3.js -->
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<script>
    // Injection depuis Flask
    const contractAddress = "{{ contract_address }}";
    const contractABI = {{ contract_abi|safe }};

    async function participer() {
        // V√©rifier le pseudo
        const pseudoInput = document.getElementById('pseudo');
        const pseudo = pseudoInput.value.trim();
        
        if (!pseudo) {
            alert("‚ö†Ô∏è Veuillez entrer votre pseudo avant de participer.");
            pseudoInput.focus();
            return;
        }

        // Validation du pseudo
        const pseudoPattern = /^[a-zA-Z0-9 _-]{2,30}$/;
        if (!pseudoPattern.test(pseudo)) {
            alert("‚ö†Ô∏è Pseudo invalide. Utilisez uniquement lettres, chiffres, espaces, tirets et underscores (2-30 caract√®res).");
            pseudoInput.focus();
            return;
        }

        if (!window.ethereum) {
            alert("‚ö†Ô∏è Veuillez installer MetaMask !");
            return;
        }

        const web3 = new Web3(window.ethereum);

        try {
            // Demande la permission √† MetaMask
            const accounts = await ethereum.request({ method: "eth_requestAccounts" });
            const userAddress = accounts[0];
            
            // Sauvegarder le pseudo avant la transaction
            const saveResponse = await fetch('/save-pseudo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    address: userAddress,
                    pseudo: pseudo
                })
            });

            const saveResult = await saveResponse.json();
            if (!saveResult.success) {
                alert("‚ö†Ô∏è " + saveResult.message);
                return;
            }

            // Transaction blockchain
            const contract = new web3.eth.Contract(contractABI, contractAddress);
            await contract.methods.participer().send({
                from: userAddress,
                value: web3.utils.toWei("1", "ether")
            });

            alert("‚úÖ F√©licitations " + pseudo + " ! Vous avez particip√© avec succ√®s.");
            window.location.href = "/";
            
        } catch (error) {
            console.error(error);
            if (error.code === 4001) {
                alert("‚ö†Ô∏è Transaction annul√©e.");
            } else {
                alert("‚ùå Erreur : " + error.message);
            }
        }
    }
</script>

{% endblock %}
