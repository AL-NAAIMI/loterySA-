{% extends "layout.html" %}

{% block content %}
<div class="container py-5">

    <h1 class="mb-4 text-center">Participer √† la loterie</h1>

    {% if not contract_address %}
        <div class="alert alert-danger">
            Aucun contrat actif n'a √©t√© d√©ploy√©.
        </div>
    {% else %}

        <p class="text-muted">Contrat actif : <code>{{ contract_address }}</code></p>

        <button class="btn btn-primary btn-lg" onclick="participer()">
            üéüÔ∏è Participer (1 Ether)
        </button>

    {% endif %}
</div>

<!-- Web3.js -->
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<script>
    // Injection depuis Flask
    const contractAddress = "{{ contract_address }}";
    const contractABI = {{ contract_abi|safe }};

    async function participer() {
        if (!window.ethereum) {
            alert("Veuillez installer MetaMask !");
            return;
        }

        const web3 = new Web3(window.ethereum);

        // Demande la permission √† MetaMask
        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        const contract = new web3.eth.Contract(contractABI, contractAddress);

        try {
            // Nom exact de la fonction Solidity : 'participer'
            await contract.methods.participer().send({
                from: accounts[0],
                value: web3.utils.toWei("1", "ether")
            });

            alert("Participation envoy√©e !");
        } catch (error) {
            console.error(error);
            alert("Erreur : " + error.message);
        }
    }
</script>

{% endblock %}